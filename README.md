# chimera-admission

`chimera-admission` is a program that allows you to register and run
Kuberntes admission webhooks that will load a WASM environment to
perform the validation of the request.

Try the pod toleration policy written in Rust:

```bash
env AW_RESOURCES=pods \
    AW_EXPORT_TOLERATION_KEY=example-key \
    AW_EXPORT_TOLERATION_OPERATOR=Exists \
    AW_EXPORT_TOLERATION_EFFECT=NoSchedule \
    AW_EXPORT_ALLOWED_GROUPS="trusted-users"\
    AW_WASM_URI=file://$(realpath ..)/pod-toleration-policy/target/wasm32-wasi/release/pod-toleration-policy.wasm make run
```

Creating this Pod will be allowed:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
    imagePullPolicy: IfNotPresent
  tolerations:
  - key: "example-key"
    operator: "Exists"
    effect: "NoSchedule"
```

Try restarting the admission controller, this time using a different value as
`AW_EXPORT_ALLOWED_GROUPS`. This time the request will be blocked.

## Fetching WASM modules from an OCI-compatible registry

Admission WASM can fetch WASM modules from an OCI-compatible registry,
like so:

```bash
env AW_RESOURCES=pods \
    AW_EXPORT_TOLERATION_KEY=example-key \
    AW_EXPORT_TOLERATION_OPERATOR=Exists \
    AW_EXPORT_TOLERATION_EFFECT=NoSchedule \
    AW_EXPORT_ALLOWED_GROUPS="trusted-users"\
    AW_WASM_URI=localhost:5000/aw/real-policy-rust:v1 make run
```

Your registry needs to be compatible with the [OCI Artifacts
specification](https://github.com/opencontainers/artifacts). You can
push WASM modules to an OCI-compatible registry that is compatible
with the OCI Artifacts specification by using the [`wasm-to-oci`
CLI](https://github.com/engineerd/wasm-to-oci).

If your registry requires login, Admission WASM will reuse the
authentication information generated by `docker login` in
`~/.docker/config.json`.
